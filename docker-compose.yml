services:
  # --- ИНФРАСТРУКТУРА ---
  # Пулер соединений (Прослойка перед БД)
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: rex_pgbouncer
    environment:
      - DB_USER=${POSTGRES_USER:-postgres}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - DB_HOST=postgres_db
      - DB_NAME=${POSTGRES_DB:-rex_db}
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=1000
      - DEFAULT_POOL_SIZE=20
      - AUTH_TYPE=scram-sha-256  # <--- ДОБАВИТЬ ЭТУ СТРОКУ
    ports:
      - "6432:5432"
    depends_on:
      - postgres_db
    restart: always
  
  
  # 1. База данных (Postgres)
  postgres_db:
    image: postgres:15-alpine
    container_name: rex_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-rex_db}
    ports:
      - "5433:5432" # Чтобы можно было подключиться через DBeaver снаружи
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 2. Очереди (RabbitMQ)
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rex_rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbit_data:/var/lib/rabbitmq
    environment:
      RABBITMQ_PROMETHEUS_RETURN_PER_OBJECT_METRICS: "true"

  # 3. Кэш (Redis)
  redis:
    image: redis:7-alpine
    container_name: rex_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # --- ПРИЛОЖЕНИЕ (PYTHON) ---

  # 4. Бот (Frontend)
  bot_polling:
    build: .
    container_name: rex_bot
    restart: always
    command: python -m src.bot.main
    env_file:
      - .env
    depends_on:
      - postgres_db
      - redis
      - rabbitmq

  # 5. AI Worker (Обработка GPT)
  worker_ai:
    build: .
    container_name: rex_worker_ai
    restart: always
    command: python -m src.workers.ai_worker
    env_file:
      - .env
    depends_on:
      - postgres_db
      - redis
      - rabbitmq

  # 6. Sender Worker (Отправка сообщений)
  worker_sender:
    build: .
    container_name: rex_worker_sender
    restart: always
    command: python -m src.workers.sender_worker
    env_file:
      - .env
    depends_on:
      - rabbitmq

  # 7. Scheduler (Планировщик)
  worker_scheduler:
    build: .
    container_name: rex_scheduler
    restart: always
    command: python -m src.workers.scheduler
    env_file:
      - .env
    depends_on:
      - postgres_db
      - redis
      - rabbitmq
  # --- МОНИТОРИНГ ---

  # 8. Loki (База данных логов)
  loki:
    image: grafana/loki:2.9.2
    container_name: rex_loki
    
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./monitoring/loki-config.yaml:/etc/loki/local-config.yaml
    restart: always

  # 9. Promtail (Агент сбора логов)
  promtail:
    image: grafana/promtail:2.9.2
    container_name: rex_promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro # Читает логи докера
      - /var/run/docker.sock:/var/run/docker.sock
      - ./monitoring/promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml
    restart: always
    depends_on:
      - loki

  # 10. Prometheus (Сбор метрик)
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: rex_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: always

  # 11. cAdvisor (Метрики контейнеров: CPU, RAM)
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: rex_cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    restart: always
    # Если ты на Windows, cadvisor может капризничать, но в WSL2 обычно работает.
    # Если не запустится - не критично для старта, просто не будет графиков CPU.

  # 12. Grafana (Дашборды)
  grafana:
    image: grafana/grafana:10.1.0
    container_name: rex_grafana
    ports:
      - "4000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin # Пароль для входа (логин admin)
    volumes:
      - grafana_data:/var/lib/grafana
    restart: always
    depends_on:
      - prometheus
      - loki



volumes:
  postgres_data:
  rabbit_data:
  redis_data:
  prometheus_data:
  grafana_data: